<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Phrase Master</title>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Polish Phrase Master">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#ffffff">
    <style>
        :root { --pol-red: #dc143c; --wrong-blue: #3498db; --bg: #f0f2f5; --card: #ffffff; --text: #333; --tile-bg: #dee2e6; --accent-blue: #1976d2; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --tile-bg: #404040; --accent-blue: #42a5f5; } }
        
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; color: var(--text); }
        
        .header { width: 100%; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .title-banner { background: linear-gradient(to bottom, #ffffff 50%, #dc143c 50%); padding: 8px 0; border-bottom: 1px solid #ccc; }
        .title { font-weight: 800; font-size: 1rem; color: #333; text-align: center; margin: 0; }

        .controls-row { width: 90%; max-width: 400px; margin: 0 auto; padding: 6px 0; display: flex; flex-direction: column; gap: 6px; }
        
        /* GENDER TOGGLE - Added seamlessly */
        .gender-toggle-row { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 4px 0; }
        .gender-label { font-size: 0.65rem; font-weight: 600; opacity: 0.6; }
        .gender-btn { background: var(--tile-bg); border: 1px solid #ccc; padding: 4px 10px; border-radius: 12px; cursor: pointer; font-size: 0.6rem; font-weight: 600; transition: all 0.2s; }
        .gender-btn.active { background: var(--pol-red); color: white; border-color: var(--pol-red); }
        
        .custom-dropdown { position: relative; width: 100%; }
        .dropdown-trigger { 
            width: 100%; background: var(--bg); border: 1px solid #ccc; color: var(--text); 
            padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; 
            text-align: left; height: 28px; display: flex; align-items: center; 
            justify-content: space-between; cursor: pointer; box-sizing: border-box;
        }
        .dropdown-trigger::after { content: '‚ñº'; font-size: 7px; color: #888; }
        .dropdown-menu { 
            position: absolute; top: 100%; left: 0; right: 0; background: var(--card); 
            border: 1px solid #ccc; border-radius: 4px; max-height: 250px; overflow-y: auto; 
            z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 8px 10px; font-size: 10px; border-bottom: 1px solid #eee; cursor: pointer; color: var(--text); display: flex; justify-content: space-between; align-items: center; }

        .progress-container { width: 100%; height: 3px; background: #ddd; }
        #progress-bar { width: 0%; height: 100%; background: var(--pol-red); transition: width 0.5s; }

        .quiz-header { background: var(--card); padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; }
        .quiz-top-row { display: flex; align-items: center; gap: 12px; width: 100%; justify-content: center; }
        .speaker-btn { background: var(--bg); border: 1px solid #ddd; border-radius: 50%; width: 42px; height: 42px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .q-text { font-size: 1rem; font-weight: 800; text-align: center; max-width: 220px; word-wrap: break-word; }
        .feedback { height: 12px; font-size: 0.7rem; font-weight: bold; margin-top: 4px; }

        .mode-tabs { display: flex; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 12px 1px; text-align: center; font-size: 0.52rem; font-weight: bold; cursor: pointer; opacity: 0.4; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--pol-red); color: var(--pol-red); }
        .counter-label { font-size: 0.4rem; margin-top: 2px; opacity: 0.7; }

        .map-section { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box;}
        
        .grid { display: grid; gap: 8px; width: 100%; max-width: 400px; }
        .grid-standard { grid-template-columns: repeat(4, 1fr); } 
        .grid-alphabet { grid-template-columns: repeat(5, 1fr); }
        
        .tile { 
            aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: var(--tile-bg); border-radius: 8px; cursor: pointer; padding: 4px; 
            text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: 0.1s; overflow: hidden;
        }
        .tile .char { font-size: 0.62rem; font-weight: 800; line-height: 1.1; word-wrap: break-word; width: 100%; }
        .tile .hint { font-size: 0.45rem; opacity: 0.7; font-weight: normal; margin-top: 2px; }
        .tile .emoji { font-size: 0.7rem; margin-top: 2px; }
        .tile.wrong { background: var(--wrong-blue) !important; color: white !important; }

        .phrasebook-list { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 4px; }
        .phrasebook-item { background: var(--card); border: 1px solid #ddd; padding: 12px; border-radius: 8px; display: flex; align-items: center; cursor: pointer; transition: background 0.2s; }
        .pb-content { flex: 1; display: flex; justify-content: space-between; align-items: center; padding-right: 10px; }
        .pb-pl { font-weight: 800; font-size: 0.85rem; color: var(--pol-red); }
        .pb-en { font-size: 0.75rem; opacity: 0.7; text-align: right; }
        .pb-copy { padding: 8px; opacity: 0.3; font-size: 0.8rem; cursor: copy; }
        .pb-header { font-size: 0.7rem; font-weight: 900; padding: 14px 8px 6px 8px; color: var(--pol-red); text-transform: uppercase; border-bottom: 2px solid #eee; margin-bottom: 4px; width: 100%; background: var(--bg); border-radius: 4px; box-sizing: border-box; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .pb-header::after { content: 'FILTER üîç'; font-size: 0.45rem; opacity: 0.5; }
        .copied { background: #e8f5e9 !important; }

        .filter-banner { width: 100%; max-width: 500px; background: var(--card); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.75rem; color: var(--accent-blue); font-weight: 800; border: 1px solid var(--accent-blue); box-sizing: border-box; }
        .reset-filter-btn { background: var(--accent-blue); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.65rem; cursor: pointer; font-weight: bold; }

        .mastered-card { background: var(--card); padding: 30px 20px; border-radius: 12px; border: 2px solid var(--pol-red); text-align: center; width: 80%; max-width: 300px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .mastered-card h2 { margin: 0 0 10px 0; color: var(--pol-red); font-size: 1.2rem; }
        .mastered-card p { font-size: 0.8rem; margin: 0 0 20px 0; opacity: 0.8; color: var(--text); }
        .repeat-btn { background: var(--pol-red); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }

        .footer { padding: 8px 8px 24px 8px; display: flex; justify-content: center; gap: 6px; border-top: 1px solid #ddd; background: var(--card); flex-shrink: 0; }
        .footer-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.6rem; padding: 6px; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1; text-align: center; }
        .active-swap { background: var(--pol-red) !important; color: white !important; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: white; text-align: center; }

        /* PWA Install Button */
        .install-banner { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--pol-red); color: white; padding: 12px 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(220,20,60,0.4); z-index: 500; display: none; align-items: center; gap: 10px; font-size: 0.75rem; font-weight: 700; }
        .install-banner.show { display: flex; }
        .install-btn { background: white; color: var(--pol-red); border: none; padding: 8px 16px; border-radius: 15px; font-weight: 700; cursor: pointer; font-size: 0.7rem; }
        .close-install { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0 5px; opacity: 0.8; }


        /* Progress Bar */
        .progress-bar { width: 100%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; margin: 8px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--pol-red); transition: width 0.3s ease; }
    </style>
</head>
<body>
<!-- PWA Install Banner -->
<div class="install-banner" id="installBanner">
    <span>üì± Install Polish Phrase Master App</span>
    <button class="install-btn" id="installBtn">Install</button>
    <button class="close-install" onclick="closeInstallBanner()">√ó</button>
</div>


<div id="overlay">
    <h1 id="overlay-title">LEVEL MASTERED! üèÜ</h1>
    <button onclick="advanceLevel()" style="padding: 12px 24px; background: var(--pol-red); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem;">Continue</button>
</div>

<div class="header">
    <div class="title-banner"><h1 class="title" id="main-title">Polish Phrase Master</h1></div>
    <div class="controls-row">
        <!-- GENDER TOGGLE - ONLY NEW ADDITION -->
        <div class="gender-toggle-row">
            <span class="gender-label">Gender:</span>
            <button class="gender-btn" id="gender-m" onclick="setGender('m')">‚ôÇ Male</button>
            <button class="gender-btn active" id="gender-both" onclick="setGender('both')">Both</button>
            <button class="gender-btn" id="gender-f" onclick="setGender('f')">‚ôÄ Female</button>
        </div>
        <!-- END GENDER TOGGLE -->
        
        <div class="custom-dropdown">
            <div class="dropdown-trigger" id="lvl-current" onclick="toggleDropdown(event)">Loading...</div>
            <div class="dropdown-menu" id="lvl-menu"></div>
        </div>
        <div style="display: flex; gap: 4px;">
            <input type="text" id="search-bar" style="flex-grow: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;" placeholder="Search phrases or categories..." oninput="handleSmartSearch()">
            <button id="lang-swap-btn" class="footer-btn" style="flex: 0 0 85px;" onclick="toggleLangSwap()">EN / PL</button>
        </div>
    </div>
</div>

<div class="progress-container"><div id="progress-bar"></div></div>

<div class="quiz-header" id="quiz-ui">
    <div class="quiz-top-row">
        <button class="speaker-btn" onclick="speakTarget()">üîä</button>
        <div class="q-content">
            <div id="q-text" class="q-text">Ready?</div>
            <div id="feedback" class="feedback"></div>
        </div>
    </div>
</div>

<div class="mode-tabs">
    <div id="tab-learning" class="tab active" onclick="switchMode('learning')">
        <span>LEARNING</span>
        <span id="learn-count" class="counter-label"></span>
    </div>
    <div id="tab-mastered" class="tab" onclick="switchMode('mastered')">
        <span>BANK</span>
    </div>
    <div id="tab-test" class="tab" onclick="switchMode('test')">
        <span>MARATHON</span>
        <span id="marathon-count" class="counter-label"></span>
    </div>
    <div id="tab-phrasebook" class="tab" onclick="switchMode('phrasebook')">
        <span>PHRASEBOOK</span>
    </div>
</div>

<div class="map-section">
    <div id="mastery-map" class="grid"></div>
    <div id="search-results-extra" class="search-results-list"></div>
</div>

<div class="footer">
    <button class="footer-btn" onclick="downloadProgress()">Save</button>
    <button class="footer-btn" onclick="document.getElementById('file-input').click()">Load</button>
    <button class="footer-btn" onclick="resetEverything()" style="color: #e74c3c;">Reset</button>
    <input type="file" id="file-input" style="display:none" onchange="importProgress(event)">
</div>

<script>
    let isSpeechMode = false;
    // ORIGINAL CODE - UNCHANGED
    let stats = JSON.parse(localStorage.getItem('pl_mastery_final')) || {};
    let completions = JSON.parse(localStorage.getItem('pl_completion_counts')) || {};
    let currentLevel = parseInt(localStorage.getItem('pl_current_level_idx')) || 0;
    
    // GENDER SUPPORT - ONLY NEW ADDITION
    let currentGender = localStorage.getItem('polishMasterGender') || 'both';
    
    let phrasesData = [], activePool = [], marathonQueue = [], allPhrasesCache = [], currentTarget = null, lastTarget = null;
    let isSwapped = false, correctStreak = 0, audioCtx = null, isMarathon = false, isPhrasebook = false;
    let pbFilterLevel = null; 
    const THRESHOLD = 3, MAX_POTENTIAL_LEVELS = 35;

    // GENDER FUNCTION - ONLY NEW ADDITION
    function setGender(gender) {
        currentGender = gender;
        localStorage.setItem('polishMasterGender', gender);
        
        // Update button states
        document.querySelectorAll('.gender-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('gender-' + gender).classList.add('active');
        
        // Reload display with new gender
        updateMap();
        if (currentTarget) {
            displayQuestionText();
        }
    }
    
    // HELPER FUNCTION - Get gender-aware display text
    function getGenderText(phrase, showOriginal = false) {
        if (showOriginal || !phrase.gender || phrase.gender !== 'both' || !phrase.variants) {
            return phrase.pl;
        }
        
        if (currentGender === 'm') {
            return phrase.variants.m;
        } else if (currentGender === 'f') {
            return phrase.variants.f;
        } else {
            return `${phrase.variants.m} / ${phrase.variants.f}`;
        }
    }
    
    // HELPER FUNCTION - Update question text with gender
    function displayQuestionText() {
        if (!currentTarget) return;
        
        if (currentTarget.lvl === 0 || (currentLevel === 0 && !isMarathon)) {
            document.getElementById('q-text').innerText = `As in: ${currentTarget.word || currentTarget.en}`;
        } else {
            if (isSwapped) {
                document.getElementById('q-text').innerText = getGenderText(currentTarget);
            } else {
                document.getElementById('q-text').innerText = currentTarget.en;
            }
        }
    }

    // ORIGINAL AUDIO FUNCTIONS - UNCHANGED
    function playNote(freq, dur, type = 'sine') {
        try {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        } catch(e){}
    }

    function playVictory() {
        playNote(523.25, 0.5); 
        setTimeout(() => playNote(659.25, 0.5), 100);
        setTimeout(() => playNote(783.99, 0.8), 200);
    }

    // ORIGINAL SCAN AND POPULATE - UNCHANGED
    async function scanAndPopulate() {
        const menu = document.getElementById('lvl-menu'); 
        menu.innerHTML = '';
        allPhrasesCache = [];
        let totalMedals = 0;

        for (let i = 0; i < MAX_POTENTIAL_LEVELS; i++) {
            try {
                const resp = await fetch(`phrases_${i}.json`);
                if (resp.ok) {
                    const data = await resp.json();
                    const isLevelDone = data.phrases.every(p => (stats[p.pl] || 0) >= THRESHOLD);
                    if (isLevelDone) totalMedals++;
                    
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `<span>Lvl ${i}: ${data.description || ''}</span><span>${isLevelDone ? 'üèÖ' : ''}</span>`;
                    
                    const lvlIdx = i;
                    item.onclick = (e) => { e.stopPropagation(); selectLevel(lvlIdx); };
                    menu.appendChild(item);

                    if(!isPhrasebook && i === currentLevel) {
                        document.getElementById('lvl-current').innerHTML = `<span>Lvl ${i}: ${data.description || ''}</span><span>${isLevelDone ? 'üèÖ' : ''}</span>`;
                    }
                    allPhrasesCache.push(...data.phrases.map(p => ({...p, lvl: lvlIdx, lvlDesc: data.description})));
                }
            } catch(e) {}
        }
        document.getElementById('main-title').innerHTML = `Polish Phrase Master <span style="font-size:0.8rem; opacity:0.8;">(üèÖ ${totalMedals})</span>`;
        if (isPhrasebook && pbFilterLevel === null) document.getElementById('lvl-current').innerHTML = `<span>Select Category</span>`;
        updateTabCounters();
    }

    function selectLevel(lvl) {
        if (isPhrasebook) {
            pbFilterLevel = lvl;
            document.getElementById('lvl-menu').classList.remove('show');
            updatePhrasebook();
            const meta = allPhrasesCache.find(p => p.lvl === lvl);
            if(meta) document.getElementById('lvl-current').innerHTML = `<span>Category: ${meta.lvlDesc}</span><span>üîç</span>`;
        } else {
            currentLevel = lvl; isMarathon = false;
            document.getElementById('lvl-menu').classList.remove('show');
            document.getElementById('search-bar').value = "";
            switchMode('learning');
            saveStats(); loadLevelData();
        }
    }

    function loadLevelData() {
        fetch(`phrases_${currentLevel}.json?v=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                phrasesData = data.phrases;
                document.getElementById('lang-swap-btn').style.display = (currentLevel === 0) ? 'none' : 'block';
                if (currentLevel === 0) activePool = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD);
                else activePool = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD).slice(0, 12);
                updateMap(); startNewRound(); updateStats(); scanAndPopulate();
            });
    }

    function switchMode(m) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + m).classList.add('active');
        isMarathon = (m === 'test'); isPhrasebook = (m === 'phrasebook');
        if(!isPhrasebook) pbFilterLevel = null;
        document.getElementById('quiz-ui').style.display = isPhrasebook ? 'none' : 'flex';
        if (isPhrasebook) updatePhrasebook(); else if (isMarathon) startMarathon(); else { updateMap(); startNewRound(); }
        updateTabCounters(); scanAndPopulate();
        updateProgressBar(); 
    }

    function startMarathon() {
        const masteredPool = allPhrasesCache.filter(p => p.lvl !== 0 && (stats[p.pl] || 0) >= THRESHOLD);
        if (masteredPool.length < 5) {
            document.getElementById('q-text').innerText = "Master 5+ items first!";
            document.getElementById('mastery-map').innerHTML = `<div class="mastered-card"><h2>Locked</h2><p>Master 5 phrases in learning mode to unlock the marathon.</p></div>`;
            return;
        }
        let shuffled = masteredPool.sort(() => 0.5 - Math.random());
        activePool = shuffled.slice(0, 12); marathonQueue = shuffled.slice(12); 
        updateMap(); startNewRound(); updateTabCounters();
    }

    function updateTabCounters() {
        const mCount = document.getElementById('marathon-count');
        const lCount = document.getElementById('learn-count');
        if (isMarathon) {
            const total = activePool.length + marathonQueue.length;
            mCount.innerText = total > 0 ? `Rem: ${total}` : ""; lCount.innerText = "";
        } else if (!isPhrasebook) {
            const remaining = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD).length;
            lCount.innerText = remaining > 0 ? `Rem: ${remaining}` : ""; mCount.innerText = "";
        } else { mCount.innerText = ""; lCount.innerText = ""; }
    }

    function updatePhrasebook(filter = "") {
        const area = document.getElementById('mastery-map');
        area.innerHTML = ''; area.className = "phrasebook-list";
        
        if (pbFilterLevel !== null && !filter) {
            const meta = allPhrasesCache.find(p => p.lvl === pbFilterLevel);
            const banner = document.createElement('div');
            banner.className = 'filter-banner';
            banner.innerHTML = `<span>Viewing: ${meta ? meta.lvlDesc : 'Category'}</span><button class="reset-filter-btn" onclick="resetPbFilter()">Show All</button>`;
            area.appendChild(banner);
        }

        let list = allPhrasesCache.filter(p => p.lvl !== 0);
        if (filter) {
            pbFilterLevel = null;
            document.getElementById('lvl-current').innerHTML = `<span>Searching...</span>`;
            list = list.filter(p => p.pl.toLowerCase().includes(filter) || p.en.toLowerCase().includes(filter) || (p.lvlDesc && p.lvlDesc.toLowerCase().includes(filter)));
        } else if (pbFilterLevel !== null) list = list.filter(p => p.lvl === pbFilterLevel);

        let currentHeader = -1;
        list.forEach(p => {
            if (!filter && pbFilterLevel === null && p.lvl !== currentHeader) {
                currentHeader = p.lvl;
                const header = document.createElement('div');
                header.className = 'pb-header';
                header.innerText = p.lvlDesc || `Level ${p.lvl}`;
                header.onclick = () => { pbFilterLevel = p.lvl; updatePhrasebook(); document.getElementById('lvl-current').innerHTML = `<span>Category: ${p.lvlDesc}</span><span>üîç</span>`; };
                area.appendChild(header);
            }
            const row = document.createElement('div');
            row.className = 'phrasebook-item';
            
            // GENDER-AWARE DISPLAY IN PHRASEBOOK
            const displayPl = getGenderText(p);
            
            row.innerHTML = `<div class="pb-content"><span class="pb-pl">${displayPl}</span><span class="pb-en">${p.en}</span></div><div class="pb-copy" onclick="copyText(event, '${p.pl.replace(/'/g, "\\'")}', this)">üìã</div>`;
            row.onclick = (e) => { if(e.target.className !== 'pb-copy') speak(p.pl); };
            area.appendChild(row);
        });
        if(list.length === 0) area.innerHTML = `<div class="empty-state-box">No matches found.</div>`;
    }

    function resetPbFilter() {
        pbFilterLevel = null;
        document.getElementById('lvl-current').innerHTML = `<span>Select Category</span>`;
        updatePhrasebook();
    }

    function copyText(e, text, el) {
        e.stopPropagation();
        navigator.clipboard.writeText(text).then(() => {
            const row = el.closest('.phrasebook-item');
            row.classList.add('copied');
            setTimeout(() => row.classList.remove('copied'), 400);
        });
    }

    // ORIGINAL UPDATE MAP - WITH GENDER SUPPORT ADDED
    function updateMap() {
        const area = document.getElementById('mastery-map'); area.innerHTML = '';
        const isLearning = document.getElementById('tab-learning').classList.contains('active');
        area.className = (currentLevel === 0 && !isMarathon) ? "grid grid-alphabet" : "grid grid-standard";
        if (isLearning && activePool.length === 0) {
            const count = completions[currentLevel] || 0;
            area.innerHTML = `<div class="mastered-card"><h2>Level Mastered! üèÖ</h2><p>You have completed this category ${count} times.</p><button class="repeat-btn" onclick="resetLevelMastery()">Repeat Level</button></div>`;
            return;
        }
        let displayList = (isMarathon || isLearning) ? activePool : phrasesData.filter(p => (stats[p.pl] || 0) >= THRESHOLD);
        displayList.forEach(p => {
            const tile = document.createElement('div'); tile.className = 'tile';
            
            // GENDER-AWARE TILE DISPLAY
            if (p.lvl === 0 || (currentLevel === 0 && !isMarathon)) {
                tile.innerHTML = `<span class="char">${p.pl}</span><span class="hint">${p.en}</span><span class="emoji">${p.e || ''}</span>`;
            } else {
                const displayText = isSwapped ? p.en : getGenderText(p);
                tile.innerHTML = `<span class="char">${displayText}</span>`;
            }
            
            if (!isMarathon) {
                const score = stats[p.pl] || 0;
                if (score > 0) tile.style.backgroundColor = `rgba(220, 20, 60, ${score/THRESHOLD})`;
            }
            tile.onclick = () => checkAnswer(p, tile);
            area.appendChild(tile);
        });
    }

    // ORIGINAL CHECK ANSWER - UNCHANGED (with victory cones!)
    function checkAnswer(phrase, el) {
        if (phrase.pl === currentTarget.pl) {
            correctStreak++; playNote(440 + (correctStreak * 40), 0.2);
            if (!isMarathon) stats[phrase.pl] = (stats[phrase.pl] || 0) + 1;
            document.getElementById('feedback').innerText = "Dobrze! üåü";
            saveStats();
            setTimeout(() => {
                const idx = activePool.findIndex(ap => ap.pl === phrase.pl);
                if (isMarathon) {
                    if (marathonQueue.length > 0) activePool[idx] = marathonQueue.shift();
                    else activePool.splice(idx, 1);
                } else {
                    if (stats[phrase.pl] >= THRESHOLD) {
                        const next = phrasesData.find(p => (stats[p.pl] || 0) < THRESHOLD && !activePool.includes(p));
                        if (next) activePool[idx] = next; else activePool.splice(idx, 1);
                    }
                }
                if (activePool.length === 0) { playVictory(); document.getElementById('overlay').style.display='flex'; }
                else { updateMap(); startNewRound(); updateTabCounters(); }
            }, 800);
        } else {
            correctStreak = 0; el.classList.add('wrong'); document.getElementById('feedback').innerText = "B≈ÇƒÖd!";
            setTimeout(() => { el.classList.remove('wrong'); if(!isMarathon) startNewRound(); }, 1200);
        }
    }

    // ORIGINAL START NEW ROUND - WITH GENDER SUPPORT
    function startNewRound() {
        if (!activePool.length) return;
        let nextTarget;
        if (activePool.length > 1) { do { nextTarget = activePool[Math.floor(Math.random() * activePool.length)];         updateProgressBar();
    } while (nextTarget === lastTarget); }
        else nextTarget = activePool[0];
        currentTarget = nextTarget; lastTarget = currentTarget;
        document.getElementById('feedback').innerText = "";
        displayQuestionText();
        speak(currentTarget.pl);
    }

    // ORIGINAL SEARCH - UNCHANGED
    function handleSmartSearch() {
        const q = document.getElementById('search-bar').value.toLowerCase();
        if (isPhrasebook) { updatePhrasebook(q); return; }
        const extra = document.getElementById('search-results-extra');
        extra.innerHTML = ''; if (!q) return;
        const matches = allPhrasesCache.filter(p => (p.pl.toLowerCase().includes(q) || p.en.toLowerCase().includes(q))).slice(0, 10);
        matches.forEach(p => {
            const item = document.createElement('div'); item.className = 'global-search-item';
            item.innerHTML = `<div><strong>${p.pl}</strong><br><small>${p.en}</small></div><div style="color:var(--pol-red); font-weight:bold; font-size:10px;">LVL ${p.lvl}</div>`;
            item.onclick = () => selectLevel(p.lvl);
            extra.appendChild(item);
        });
    }

    // ORIGINAL FUNCTIONS - ALL UNCHANGED
    function speak(t, rate = 1.0) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t); m.lang = 'pl-PL'; m.rate = rate;
        window.speechSynthesis.speak(m);
    }

    function speakTarget() {
        const now = Date.now();
        const rate = (now - (window.lastTap || 0) < 400) ? 0.5 : 1.0;
        window.lastTap = now;
        if(currentTarget) speak(currentTarget.pl, rate);
    }

    function toggleLangSwap() { isSwapped = !isSwapped; document.getElementById('lang-swap-btn').classList.toggle('active-swap', isSwapped); updateMap(); if(!isPhrasebook) startNewRound(); }
    function toggleDropdown(e) { e.stopPropagation(); document.getElementById('lvl-menu').classList.toggle('show'); }
    function saveStats() { localStorage.setItem('pl_mastery_final', JSON.stringify(stats)); localStorage.setItem('pl_current_level_idx', currentLevel); localStorage.setItem('pl_completion_counts', JSON.stringify(completions)); }
    function updateStats() { if (!phrasesData.length) return; const m = phrasesData.filter(p=>(stats[p.pl]||0)>=THRESHOLD).length; document.getElementById('progress-bar').style.width = (m/phrasesData.length)*100+"%"; }
    function advanceLevel() { document.getElementById('overlay').style.display='none'; if(isMarathon) switchMode('learning'); else { currentLevel++; selectLevel(currentLevel); } }
    function resetLevelMastery() { completions[currentLevel] = (completions[currentLevel] || 0) + 1; phrasesData.forEach(p => stats[p.pl] = 0); saveStats(); loadLevelData(); }
    function downloadProgress() { const b = new Blob([JSON.stringify({stats, completions, currentLevel})], {type: "text/plain"}); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `progress.txt`; a.click(); }
    function importProgress(e) { const r = new FileReader(); r.onload = (ev) => { const d = JSON.parse(ev.target.result); stats = d.stats; completions = d.completions || {}; currentLevel = d.currentLevel; saveStats(); location.reload(); }; r.readAsText(e.target.files[0]); }
    function resetEverything() { if(confirm("Reset all?")) { localStorage.clear(); location.reload(); } }
    window.onclick = () => document.getElementById('lvl-menu').classList.remove('show');
    
    // Initialize with saved gender preference
    window.onload = () => {
        loadLevelData();
        setGender(currentGender);
    };


    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => console.log('Service Worker registered:', reg.scope))
                .catch(err => console.log('Service Worker registration failed:', err));
        });
    }

    // PWA Install Prompt
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install banner if not already installed
        if (!window.matchMedia('(display-mode: standalone)').matches) {
            setTimeout(() => {
                document.getElementById('installBanner').classList.add('show');
            }, 3000); // Show after 3 seconds
        }
    });

    document.getElementById('installBtn')?.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('User accepted install');
            document.getElementById('installBanner').classList.remove('show');
        }
        
        deferredPrompt = null;
    });

    function closeInstallBanner() {
        document.getElementById('installBanner').classList.remove('show');
        localStorage.setItem('installBannerDismissed', 'true');
    }

    // Hide install banner if already dismissed
    if (localStorage.getItem('installBannerDismissed') === 'true') {
        document.getElementById('installBanner')?.remove();
    }

    // Detect if running as installed app
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('Running as installed PWA');
    }



    // Double-tap speaker for slow playback
    let lastSpeakerTap = 0;
    let lastTappedPhrase = null;

    function speakSlow(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'pl-PL';
        utterance.rate = 0.6; // 60% speed
        speechSynthesis.speak(utterance);
    }



    function handleSpeakerClick(phrase, event) {
        if (event) event.stopPropagation();
        
        const now = Date.now();
        const timeSince = now - lastSpeakerTap;
        
        // Get gender-specific text
        const phraseObj = typeof phrase === 'string' ? activePool.find(p => p.pl === phrase) : phrase;
        const textToSpeak = phraseObj ? getGenderText(phraseObj, true) : (typeof phrase === 'string' ? phrase : phrase.pl);
        
        if (timeSince < 500 && lastTappedPhrase === textToSpeak) {
            // Double-tap - slow playback
            speakSlow(textToSpeak);
        } else {
            // Single tap - normal playback
            speak(textToSpeak);
        }
        
        lastSpeakerTap = now;
        lastTappedPhrase = textToSpeak;
    }



    // Progress bar (learning mode only)
    function updateProgressBar() {
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        
        if (!progressContainer || !progressFill) return;
        
        // Only show in learning mode
        const isLearningMode = !isMarathon && !isPhrasebook && !isSpeechMode;
        
        if (isLearningMode && phrasesData && phrasesData.length > 0) {
            progressContainer.style.display = 'block';
            
            const total = phrasesData.length;
            const mastered = phrasesData.filter(p => (stats[p.pl] || 0) >= THRESHOLD).length;
            const percentage = (mastered / total) * 100;
            
            progressFill.style.width = percentage + '%';
        } else {
            progressContainer.style.display = 'none';
        }
    }

</script>
</body>
</html>
